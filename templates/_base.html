<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Sports pages curation tool</title>
    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/css/select2.min.css">
    
    <!--  <link rel="stylesheet" type="text/css" href="https://unpkg.com/tachyons@4.10.0/css/tachyons.min.css"> -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='app.css') }}">
</head>
<body class="bg-light" style="padding-top: 72px;">
    {%- include 'includes/_navbar.html' -%}
    {%- block body %}{% endblock -%}

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/js/select2.min.js"></script>

<!--     {% if (page == 'add_entry') or (page == 'view_entry') %}
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.ckeditor.com/4.8.0/basic/ckeditor.js"></script> -->
   
<!--     <script>
            CKEDITOR.replace( 'inputContent' );
            CKEDITOR.config.contentsCss = '/static/css/contents.css';
            CKEDITOR.config.disableNativeSpellChecker = false;
    </script> -->
<!--     {% endif %} -->

<!--     <script src="https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/2.9.4/trumbowyg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/2.9.4/plugins/cleanpaste/trumbowyg.cleanpaste.min.js"></script>
    <script type="text/javascript">
        $('#inputContent').trumbowyg({
            removeformatPasted: true,
            autogrow: true,
        });
    </script> -->
    <script>

function build_options(new_list, old_list, identifier, menu_kind) {
// new_list: new options for next menu
// old_list: current selection in next menu
// db_list: values currently in db for asset
// menu_kind: categories, topics or tags
console.log("New list is:", new_list);
console.log("Old list is:", old_list);
var html = [];
html = new_list.map((val) => {
  if (old_list.includes(val)) {
    console.log("current selection");
    return '<option value="' + identifier + '__' + menu_kind + '_user__' + val + '" selected>' + val + "</option>";
  } else {
    console.log("new selection");
    return '<option value="' + identifier + '__' + menu_kind + '_user__' + val + '">' + val + "</option>";
  }
});
console.log("HTML is: ", html);
return html.join("");
}

function findProp(obj, key, out) {
var i,
  proto = Object.prototype,
  ts = proto.toString,
  hasOwn = proto.hasOwnProperty.bind(obj);

if ("[object Array]" !== ts.call(out)) out = [];

for (i in obj) {
  if (hasOwn(i)) {
    if (i === key) {
      out.push(obj[i]);
    } else if (
      "[object Array]" === ts.call(obj[i]) ||
      "[object Object]" === ts.call(obj[i])
    ) {
      findProp(obj[i], key, out);
    }
  }
}
return out;
}

$(document).ready(function() {
$(".test").select2(); // initialize

var taxonomy = {
  News: {
    Municipal_Election: {
      mayor: ["eisenberger", "graydon"],
      wards: ["ward_1", "ward_2"]
    }
  },
  Opinion: {
    Column: {
      col: [""]
    },
    Commentary: {
      comm: [""]
    }
  },
  Sports: {
    Hockey: {
      NHL: ["Leafs", "Habs", "Sabres"],
      OHL: ["Bulldogs", "Rangers", "Storm"]
    },
    Football: {
      CFL: ["Ticats", "Bombers", "Argos", "Stampeders"],
      NFL: ["Bills", "Jets", "Giants", "Dolphins"]
    }
  }
};
var nextUp = {
  sections: "categories",
  categories: "topics",
  topics: "tags"
};

$(".test").change(function() {
  var nextMenuOptions = [];
  // NEED TO KEEP ORIGINAL SELECTED VALUES AS PAGE BUILT WITH
  // Get the id, type of this module
  var menuID = String($(this).attr("id"));
  var string_parts = menuID.split("__");
  var assetID = string_parts[0];
  // console.log("Asset is: ", assetID);
  var menuKind = string_parts[1];
  if (menuKind != 'tags') {
    // get the kind of the next menu
    var nextMenuKind = nextUp[menuKind];
    // Get the selection in this module
    var menuSelection = $(this).val();
    // Then get the selector for the next menu in this module
    var nextMenuID = "#" + assetID + "__" + nextUp[menuKind];
    console.log("Next Menu ID is: ", nextMenuID);
    // Get the selection for the next menu in this module
    var nextMenuSelection = $(nextMenuID).val().map( function(value, index) {
      return ((value.split("__"))[2]).replace('_user', '');                                                                                   
    });
    console.log("nexMenuSelection is:", nextMenuSelection);
    // Calculate the possible options available for next menu
    // while re-selecting the current selection
    $.each(menuSelection, function(index, value) {
      console.log("Value is: ", value);
      value = (value.split("__"))[2]
      var temp = findProp(taxonomy, value);
      console.log(temp);
      if (menuKind == "topics") {
        var nextMenuItems = temp[0];
      } else {
        var nextMenuItems = Object.keys(temp[0]);
      }
      $.each(nextMenuItems, function(index, value) {
        nextMenuOptions.push(value);
      }); // end inner each
    }); // end outer each
    // console.log("Child list is: ", nextMenuOptions);
    var html = build_options(
      nextMenuOptions,
      nextMenuSelection,
      assetID,
      nextMenuKind
    );
    console.log("HTML is: ", html);
    $(nextMenuID).html(html);
  }
}); // end change
}); // end ready function


    </script>
</body>
</html>